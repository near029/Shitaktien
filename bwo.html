<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meine Spotify Auswertung</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Chart.js & DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    /* Dein CSS bleibt unverÃ¤ndert, nur aus PlatzgrÃ¼nden hier gekÃ¼rzt */
    :root {
      --spotify-green: #1DB954;
      --spotify-light: #1ed760;
      --dark-bg: #121212;
      --dark-card: #181818;
      --light-bg: #f9f9f9;
      --light-card: #fff;
      --light-text: #333;
    }
    body {
      background-color: var(--dark-bg);
      color: var(--spotify-green);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
      display: flex;
      min-height: 100vh;
    }
    /* ...restliches CSS unverÃ¤ndert... */
  </style>
</head>
<body>
  <!-- Dark Mode Toggle -->
  <button id="darkModeToggle" aria-label="Toggle Dark Mode">ğŸŒ</button>

  <!-- Sidebar -->
  <nav class="sidebar" aria-label="Hauptnavigation">
    <h2>MenÃ¼</h2>
    <a href="lieblingskuenstler.html" tabindex="0">ğŸµ LieblingskÃ¼nstler</a>
    <a href="genre-trends.html" tabindex="0">ğŸ“ˆ Genre-Trends</a>
    <a href="#" tabindex="0">â± HÃ¶rgewohnheiten</a>
    <select id="genreFilter" aria-label="Genre Filter" title="Genre auswÃ¤hlen">
      <option value="all" selected>Alle Genres</option>
      <option value="pop">Pop</option>
      <option value="rock">Rock</option>
      <option value="hiphop">Hip-Hop</option>
      <option value="electronic">Electronic</option>
      <option value="classical">Klassik</option>
    </select>
  </nav>

  <!-- Hauptinhalt -->
  <main class="main-content">
    <a href="index.html" class="btn btn-outline-light btn-back">
      <i class="bi bi-arrow-left"></i> ZurÃ¼ck zur Startseite
    </a>
    <h1 class="mb-4">
      <i class="bi bi-graph-up-arrow icon"></i>Erweiterte Spotify Auswertung
    </h1>
    <div id="playlist-container">Loading playlists...</div>
    <!-- ... weitere Inhalte ... -->

    <!-- Chart Bereich -->
    <div class="row mt-5">
      <div class="col-12 col-md-8 offset-md-2">
        <div class="card p-4">
          <h3 class="mb-4"><i class="bi bi-bar-chart icon"></i>HÃ¤ufig gehÃ¶rte Genres</h3>
          <canvas id="genreChart" aria-label="Chart Ã¼ber hÃ¤ufig gehÃ¶rte Genres" role="img"></canvas>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    // --- Dark Mode ---
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    if (localStorage.getItem('darkMode') === 'off') {
      body.classList.add('light-mode');
      darkModeToggle.textContent = 'ğŸŒ™';
    }
    darkModeToggle.addEventListener('click', () => {
      if (body.classList.contains('light-mode')) {
        body.classList.remove('light-mode');
        localStorage.setItem('darkMode', 'on');
        darkModeToggle.textContent = 'ğŸŒ';
      } else {
        body.classList.add('light-mode');
        localStorage.setItem('darkMode', 'off');
        darkModeToggle.textContent = 'ğŸŒ™';
      }
    });

    // --- Chart.js Setup ---
    const genresData = {
      all:   { labels: ['Pop', 'Rock', 'Hip-Hop', 'Electronic', 'Klassik'], counts: [40, 25, 15, 10, 10] },
      pop:   { labels: ['Pop 1', 'Pop 2', 'Pop 3'], counts: [15, 10, 15] },
      rock:  { labels: ['Rock 1', 'Rock 2', 'Rock 3'], counts: [10, 8, 7] },
      hiphop:{ labels: ['Hip-Hop 1', 'Hip-Hop 2'], counts: [9, 6] },
      electronic:{ labels: ['Electronic 1', 'Electronic 2', 'Electronic 3'], counts: [5, 3, 2] },
      classical: { labels: ['Klassik 1', 'Klassik 2'], counts: [6, 4] },
    };

    const ctx = document.getElementById('genreChart').getContext('2d');
    let genreChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: genresData.all.labels,
        datasets: [{
          label: 'Anzahl gespielter Tracks',
          data: genresData.all.counts,
          backgroundColor: 'rgba(54, 162, 235, 1)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          borderRadius: 5,
        }],
      },
      options: {
        responsive: true,
        animation: { duration: 600 },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              color: '#1DB954',
              stepSize: 5,
            },
            grid: {
              color: '#333',
            },
          },
          x: {
            ticks: {
              color: '#1DB954',
            },
            grid: {
              color: 'transparent',
            },
          },
        },
        plugins: {
          datalabels: {
            color: '#1DB954',
            font: { weight: 'bold', size: 14 }
          },
          legend: {
            labels: {
              color: '#1DB954',
              font: { size: 14 },
            },
          },
          tooltip: {
            backgroundColor: '#222',
            titleColor: '#1DB954',
            bodyColor: '#1DB954',
          },
        },
      },
      plugins: [ChartDataLabels],
    });

    document.getElementById('genreFilter').addEventListener('change', (e) => {
      const selected = e.target.value;
      const data = genresData[selected] || genresData.all;
      genreChart.data.labels = data.labels;
      genreChart.data.datasets[0].data = data.counts;
      genreChart.update();
    });

    // --- PKCE Helper Functions ---
    // URL-sichere Base64 (RFC 4648 Â§5)
    function base64UrlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function generateCodeVerifier(length = 128) {
      const array = new Uint8Array(length);
      crypto.getRandomValues(array);
      // nur sichere Base64 URL
      return base64UrlEncode(array);
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return base64UrlEncode(digest);
    }

    // --- OAuth2 PKCE Flow ---
    async function redirectToAuthCodeFlow(clientId) {
      const verifier = generateCodeVerifier();
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem('pkce_verifier', verifier);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: clientId,
        redirect_uri: window.location.origin + window.location.pathname,
        scope: 'user-top-read user-read-private',
        code_challenge_method: 'S256',
        code_challenge: challenge,
      });

      window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function getAccessToken(clientId, code) {
      const verifier = localStorage.getItem('pkce_verifier');
      const params = new URLSearchParams({
        grant_type: 'authorization_code',
        code,
        redirect_uri: window.location.origin + window.location.pathname,
        client_id: clientId,
        code_verifier: verifier,
      });

      // Achtung: Spotify blockiert CORS auf diesen Endpunkt,
      // daher nur mit Backend-Proxy oder serverseitig nutzbar!
      try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params.toString(),
        });

        if (!response.ok) throw new Error('Token konnte nicht geholt werden');

        const data = await response.json();
        return data.access_token;
      } catch (e) {
        console.error(e);
        alert('Fehler beim Abrufen des Tokens. Benutze einen Server-Proxy!');
      }
    }

    // --- Hauptlogik ---
    async function main() {
      const clientId = '5db2bd0986654ef98bff31892d4f818f';
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      let accessToken;

      if (!code) {
        // Kein Code: Weiterleiten zu Spotify Auth
        redirectToAuthCodeFlow(clientId);
      } else {
        // Code vorhanden: Access Token holen
        accessToken = await getAccessToken(clientId, code);
        if (!accessToken) return;
        localStorage.setItem('spotify_access_token', accessToken);
        // URL bereinigen
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      if (!accessToken) {
        accessToken = localStorage.getItem('spotify_access_token');
      }

      if (!accessToken) {
        // Token fehlt: neu starten
        redirectToAuthCodeFlow(clientId);
        return;
      }

      // Beispiel: Nutzerprofil abrufen
      const userProfile = await fetch('https://api.spotify.com/v1/me', {
        headers: { Authorization: 'Bearer ' + accessToken },
      }).then(r => r.json());

      document.getElementById('playlist-container').innerText =
        `Hallo ${userProfile.display_name}! Hier kannst du deine Spotify-Daten sehen.`;

      // Weitere Daten laden, Charts fÃ¼llen usw...
    }

    main();
  </script>
</body>
</html>

})();

  </script>
</body>
</html>
        }

        init();
</script>
